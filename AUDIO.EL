#OUTPUT "AUDIO"'--------.DECLARES'--------#DECLARE A$, T, OLDX, OLDY, DT, V, K#DECLARE STATE, STATE$(4)#DECLARE XPOS, YPOS, FRAME(4), OLD╞FRAME(4)#DECLARE FSTART, FPLAYBACK, FLOOP, FEND, LOOPING, SRATE#DECLARE SIDX#DECLARE DT╞SEMI = 1.05946309436#DECLARE NOTE╞KEY$(11), OCTAVE = 0#DECLARE V$, CH$#DECLARE AUDIOIDX, SEQSTATE#DECLARE NOTEMAP(6), SHARPNOTEMAP(6), DURATION, SHARP╞FLAG, DOTTED╞FLAG'-------.DEFINES'-------#DEFINE стате╞маин = 0#DEFINE стате╞фстарт = 1#DEFINE стате╞фплаыбацк = 2#DEFINE стате╞флооп = 3#DEFINE стате╞фенд = 4#DEFINE фрм╞старт    = 0#DEFINE фрм╞плаыбацк = 1#DEFINE фрм╞лооп     = 2#DEFINE фрм╞енд      = 3#DEFINE важ╞сизе = $D246#STRUCT сампле NAME$, LOOPING, START%, PLAYBACK, LOOP, FINISH, SRATE#DEFINE сея╞маин = 0#DEFINE сея╞селецт╞сампле = 1#DEFINE тимегап = .05'----.INIT'----  STATE$(0) = "MAIN:   "  STATE$(1) = "FSTART: "  STATE$(2) = "FPLAYBK:"  STATE$(3) = "FLOOP:  "  STATE$(4) = "FEND:   "  OLD╞FRAME(фрм╞старт) = -1  OLD╞FRAME(фрм╞плаыбацк) = -1  OLD╞FRAME(фрм╞лооп) = -1  OLD╞FRAME(фрм╞енд) = -1  сампле SAMPLE(5) = [ _    [ "GET", 1, 0,     1631,  2091,  3700, $19E4 ], _    [ "TO",  0, 3700,  0,     0,     5710, $1CA0 ], _    [ "THE", 0, 5800,  0,     0,     8000, $1C64 ], _    [ "CHO", 1, 8601,  11334, 12100, 14200, $1C3C ], _    [ "PER", 1, 14301, 16830, 17796, 26914, $1C6E ], _    [ "ALL", 0, 0,     0,     0,     26914, $19E4 ] _  ]  NOTE╞KEY$(0)  = "A"  ' C  NOTE╞KEY$(1)  = "W"  ' C#  NOTE╞KEY$(2)  = "S"  ' D  NOTE╞KEY$(3)  = "E"  ' D#  NOTE╞KEY$(4)  = "D"  ' E  NOTE╞KEY$(5)  = "F"  ' F  NOTE╞KEY$(6)  = "T"  ' F#  NOTE╞KEY$(7)  = "G"  ' G  NOTE╞KEY$(8)  = "Y"  ' G#  NOTE╞KEY$(9)  = "H"  ' A  NOTE╞KEY$(10) = "U"  ' A#  NOTE╞KEY$(11) = "J"  ' B  NOTEMAP(0) = 0  ' C  NOTEMAP(1) = 2  ' D  NOTEMAP(2) = 4  ' E  NOTEMAP(3) = 5  ' F  NOTEMAP(4) = 7  ' G  NOTEMAP(5) = 9  ' A  NOTEMAP(6) = 11 ' B    SHARPNOTEMAP(0) = 1  ' C#  SHARPNOTEMAP(1) = 3  ' D#  SHARPNOTEMAP(2) = 5  ' E# = F  SHARPNOTEMAP(3) = 6  ' F#  SHARPNOTEMAP(4) = 8  ' G#  SHARPNOTEMAP(5) = 10 ' A#  SHARPNOTEMAP(6) = 11 ' B# (OUGHT TO BE HIGH C, BUT LET'S IGNORE IT FOR NOW)'----.MAIN'----  BLOAD "CHOPPER16K.RAW",P($50000)  GOSUB SEQUENCER  GOSUB PIANO╞MODE  GOSUB INIT╞SCREEN  GOSUB DRAW╞AUDIO  MOUSE ON, 1, 0  DMODE 0, 1, 0, 0, 0  GOSUB GET╞INPUT  SCREEN CLOSE  MOUSE OFF  END'---------.SEQUENCER'---------  PRINT CHR$(147);  DO WHILE 1    DURATION = 4  ' DEFAULT TO QUARTER NOTE    SHARP╞FLAG = 0    DOTTED╞FLAG = 0    OCTAVE = 0        INPUT "";V$    SEQSTATE = сея╞маин    ' PARSE AND PLAY THE AUDIO STRING    FOR AUDIOIDX = 1 TO LEN(V$)      CH$ = MID$(V$, AUDIOIDX, 1)      IF SEQSTATE = сея╞маин THEN BEGIN        IF CH$ = "%" THEN SEQSTATE = сея╞селецт╞сампле        IF CH$ = "#" THEN SHARP╞FLAG = 1        IF CH$ = "." THEN DOTTED╞FLAG = 1        IF CH$ = "-" THEN OCTAVE = OCTAVE - 1        IF CH$ = "+" THEN OCTAVE = OCTAVE + 1        IF CH$ >= "A" AND CH$ <= "G" THEN BEGIN          IF CH$ >= "C" THEN K = ASC(CH$) - ASC("C")          IF CH$ = "A" THEN K = 5          IF CH$ = "B" THEN K = 6          SRATE = SAMPLE╞SRATE(SIDX)          IF SHARP╞FLAG THEN BEGIN            SRATE = SRATE * DT╞SEMI ^ (SHARPNOTEMAP(K) + OCTAVE * 12)          BEND : ELSE BEGIN            SRATE = SRATE * DT╞SEMI ^ (NOTEMAP(K) + OCTAVE * 12)          BEND          SHARP╞FLAG = 0          GOSUB PLAY╞WITH╞SRATE          IF DOTTED╞FLAG THEN BEGIN            SLEEP тимегап * DURATION * 1.5          BEND : ELSE BEGIN            SLEEP тимегап * DURATION          BEND          DOTTED╞FLAG = 0          IF SAMPLE╞LOOPING(SIDX) THEN GOSUB END╞AUDIO╞LOOPING        BEND        IF CH$ = "S" THEN DURATION = 1        IF CH$ = "I" THEN DURATION = 2        IF CH$ = "Q" THEN DURATION = 4        IF CH$ = "H" THEN DURATION = 8        IF CH$ = "W" THEN DURATION = 16        IF CH$ = "R" THEN SLEEP тимегап * DURATION      BEND : GOTO SKIP╞SEQ      IF SEQSTATE = сея╞селецт╞сампле THEN BEGIN        SIDX = VAL(CH$)        ' PRINT "SIDX=";SIDX;"(";CH$;")"        SEQSTATE = сея╞маин      BEND.SKIP╞SEQ    NEXT AUDIOIDX  LOOP  RETURN'----------.PIANO╞MODE'----------  DO WHILE 1    GET KEY A$    IF A$ >= "1" AND A$ <= "6" THEN SIDX = ASC(A$) - ASC("1") : GOSUB PLAY╞WITH╞INFO    IF A$ = "," THEN SAMPLE╞SRATE(SIDX) = SAMPLE╞SRATE(SIDX) - 1 : GOSUB PLAY╞WITH╞INFO    IF A$ = "." THEN SAMPLE╞SRATE(SIDX) = SAMPLE╞SRATE(SIDX) + 1 : GOSUB PLAY╞WITH╞INFO    IF A$ = "<" THEN SAMPLE╞SRATE(SIDX) = SAMPLE╞SRATE(SIDX) - 50 : GOSUB PLAY╞WITH╞INFO    IF A$ = ">" THEN SAMPLE╞SRATE(SIDX) = SAMPLE╞SRATE(SIDX) + 50 : GOSUB PLAY╞WITH╞INFO        IF A$ = ";" THEN BEGIN      OCTAVE = OCTAVE - 1      PRINT "OCTAVE =";OCTAVE    BEND    IF A$ = ":" THEN BEGIN      OCTAVE = OCTAVE + 1      PRINT "OCTAVE =";OCTAVE    BEND    IF A$ = "@" THEN BEGIN      OCTAVE = OCTAVE - .02      PRINT "OCTAVE =";OCTAVE    BEND    IF A$ = "*" THEN BEGIN      OCTAVE = OCTAVE + .2      PRINT "OCTAVE =";OCTAVE    BEND    GOSUB CHECK╞NOTES    IF A$ = "X" THEN END  LOOP  RETURN'-----------.CHECK╞NOTES'-----------  FOR K = 0 TO 11    IF A$ = NOTE╞KEY$(K) THEN BEGIN      SRATE = SAMPLE╞SRATE(SIDX)      SRATE = SRATE * DT╞SEMI ^ (K + OCTAVE * 12)      GOSUB PLAY╞WITH╞SRATE    BEND  NEXT K  RETURN'--------------.PLAY╞WITH╞INFO'--------------  ' PRINT "SAMPLE#";MID$(STR$(SIDX),2);" @ ";HEX$(SAMPLE╞SRATE(SIDX))  GOSUB PLAY╞SAMPLE╞AUDIO  RETURN'--------------.PLAY╞WITH╞SRATE'--------------  ' PRINT "SAMPLE#";MID$(STR$(SIDX),2);" @ ";HEX$(SRATE)  GOSUB PLAY╞VAR╞SRATE  RETURN'---------.DRAW╞INFO'---------  A$ = STATE$(STATE) + "FSTART =" _    + STR$(FRAME(фрм╞старт)) _    + ", FPLAYBK =" + STR$(FRAME(фрм╞плаыбацк)) _    + ", FLOOP = " + STR$(FRAME(фрм╞лооп)) _    + ", FEND =" + STR$(FRAME(фрм╞енд))  XPOS = 0 : YPOS = 0  GOSUB DRAW╞TEXT  IF STATE >= стате╞фстарт AND STATE <= стате╞фенд THEN BEGIN    V = WPEEK($50000 + FRAME(STATE - 1) * 2)    IF V AND 32768 THEN V = V - 65535    A$ = "SAMPLE = " + STR$(V)    XPOS = 0 : YPOS = 1    GOSUB DRAW╞TEXT    IF OLD╞FRAME(STATE-1) <> -1 THEN BEGIN      LINE OLD╞FRAME(STATE-1), 16, OLD╞FRAME(STATE-1), 399    BEND    T = FRAME(STATE-1) * 640 / (важ╞сизе / 2)    LINE T, 16, T, 399    OLD╞FRAME(STATE-1) = T  BEND  RETURN'---------.GET╞INPUT'---------  DO WHILE 1    GOSUB DRAW╞INFO    GET KEY A$    IF A$ = "1" THEN STATE = стате╞фстарт    IF A$ = "2" THEN STATE = стате╞фплаыбацк    IF A$ = "3" THEN STATE = стате╞флооп    IF A$ = "4" THEN STATE = стате╞фенд    IF A$ = "P" THEN GOSUB PLAY╞AUDIO     IF A$ = ">" THEN GOSUB BIG╞INCR    IF A$ = "<" THEN GOSUB BIG╞DECR    IF A$ = "." THEN GOSUB LITTLE╞INCR    IF A$ = "," THEN GOSUB LITTLE╞DECR    IF A$ = "X" THEN EXIT  LOOP  RETURN'--------.BIG╞INCR'--------  IF STATE = стате╞маин THEN RETURN  FRAME(STATE-1) = FRAME(STATE-1) + 100  IF FRAME(STATE-1) > (важ╞сизе / 2) THEN FRAME(STATE-1) = важ╞сизе/2-1  RETURN'--------.BIG╞DECR'--------  IF STATE = стате╞маин THEN RETURN  FRAME(STATE-1) = FRAME(STATE-1) - 100  IF FRAME(STATE-1) < 0 THEN FRAME(STATE-1) = 0  RETURN'-----------.LITTLE╞INCR'-----------  IF STATE = стате╞маин THEN RETURN  FRAME(STATE-1) = FRAME(STATE-1) + 1  IF FRAME(STATE-1) > (важ╞сизе / 2) THEN FRAME(STATE-1) = важ╞сизе/2-1  RETURN'-----------.LITTLE╞DECR'-----------  IF STATE = стате╞маин THEN RETURN  FRAME(STATE-1) = FRAME(STATE-1) - 1  IF FRAME(STATE-1) < 0 THEN FRAME(STATE-1) = 0  RETURN'---------.DRAW╞TEXT'---------  ' CLEAR PRIOR TEXT  CHAR XPOS, YPOS*8, 1, 1, 2, CHR$(2)+"                                                                     "  CHAR XPOS, YPOS*8, 1, 1, 2, A$  RETURN'-----------.INIT╞SCREEN'-----------  SCREEN 0, 640, 400, 1  PEN 1  RETURN'----------.DRAW╞AUDIO'----------  T = 0  OLDX = 0  OLDY = 200  DT = 640 / 26915  FOR K = $50000 TO $5D246 STEP 2    V = WPEEK(K)    IF V AND 32768 THEN V = V - 65535    'PRINT V    'GET KEY A$    V = V * 200 / 32768 + 200    LINE OLDX, OLDY, T, V    OLDX = T    OLDY = V    T = (K - $50000) / 2 * 640 / 26915  NEXT K  RETURN'---------------------.PLAY╞AUDIO╞FROM╞FRAME'---------------------  FSTART = FRAME(фрм╞старт)  FPLAYBACK = FRAME(фрм╞плаыбацк)  FLOOP = FRAME(фрм╞лооп)  FEND = FRAME(фрм╞енд)  LOOPING = 1  SRATE = $19E4  GOSUB PLAY╞AUDIO  RETURN'-----------------.PLAY╞SAMPLE╞AUDIO'-----------------  SRATE = SAMPLE╞SRATE(SIDX)  GOSUB PLAY╞VAR╞SRATE  RETURN'--------------.PLAY╞VAR╞SRATE'--------------  FSTART = SAMPLE╞START%(SIDX)  FPLAYBACK = SAMPLE╞PLAYBACK(SIDX)  FLOOP = SAMPLE╞LOOP(SIDX)  FEND = SAMPLE╞FINISH(SIDX)  LOOPING = SAMPLE╞LOOPING(SIDX)  GOSUB PLAY╞AUDIO  RETURN'----------.PLAY╞AUDIO'----------  ' SWITCH OFF DIGI CHANNEL 0  POKE $D720, 0  ' ENABLE AUDIO DMA  SETBIT $D711, 7  ' SAMPLE STARTS AT $5.0000  V = FPLAYBACK * 2  POKE $D721, V AND 255  POKE $D722, V / 256  POKE $D723, $05  ' SET PLAYHEAD TO BEGINNING  V = FSTART * 2  POKE $D72A, V AND 255  POKE $D72B, V / 256  POKE $D72C, $05  ' END (LOOP-POINT) OF SAMPLE  IF LOOPING THEN V = FLOOP * 2 : ELSE V = FEND * 2  WPOKE $D727, V  ' SET DIGI CH0 L/R VOLUMES  POKE $D71C,$22 : POKE $D729, $22  ' SAMPLE╞RATE = (16000 * 2^24) / (40.5 * 10^6) = 6628 = $19е4  ' SAMPLE RATE 16KхZ  POKE $D724, SRATE AND 255  POKE $D725, (SRATE / 256) AND 255  POKE $D726, (SRATE / 65536) AND 255  ' PLAY UNSIGNED 16-BIT SOUND WITH LOOPING  K = $80 + $03  IF LOOPING THEN K = K + $40  POKE $D720, K  RETURN'-----------------.END╞AUDIO╞LOOPING'-----------------  ' SWITCH IT OFF!  ' --------------  ' END (LOOP-POINT) OF SAMPLE  V = FEND * 2  WPOKE $D727, V  ' PLAY UNSIGNED 16-BIT SOUND WITHOUT LOOPING  POKE $D720, $80 + $00 + $03  RETURN