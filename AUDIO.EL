#OUTPUT "AUDIO"'--------.DECLARES'--------#DECLARE A$, T, OLDX, OLDY, DT, V, K#DECLARE STATE, STATE$(4)#DECLARE XPOS, YPOS, FRAME(4), OLDØFRAME(4)#DECLARE FSTART, FPLAYBACK, FLOOP, FEND, LOOPING, SRATE#DECLARE SIDX#DECLARE DTØSEMI = 1.05946309436#DECLARE NOTEØKEY$(11), OCTAVE = 0#DECLARE V$, CH$#DECLARE AUDIOIDX, SEQSTATE#DECLARE NOTEMAP(6), SHARPNOTEMAP(6), DURATION, SHARPØFLAG, DOTTEDØFLAG#DECLARE MYTEMPO, DTØDIGI, ISØDIGIØPLAYING, DIGIØSTART, TIMEØDURATION#DECLARE ISØREST'-------.DEFINES'-------#DEFINE ”‘¡‘≈ØÕ¡…Œ = 0#DEFINE ”‘¡‘≈Ø∆”‘¡“‘ = 1#DEFINE ”‘¡‘≈Ø∆–Ã¡Ÿ¬¡√À = 2#DEFINE ”‘¡‘≈Ø∆Ãœœ– = 3#DEFINE ”‘¡‘≈Ø∆≈Œƒ = 4#DEFINE ∆“ÕØ”‘¡“‘    = 0#DEFINE ∆“ÕØ–Ã¡Ÿ¬¡√À = 1#DEFINE ∆“ÕØÃœœ–     = 2#DEFINE ∆“ÕØ≈Œƒ      = 3#DEFINE ◊¡÷Ø”…⁄≈ = $D246#STRUCT ”¡Õ–Ã≈ NAME$, LOOPING, START%, PLAYBACK, LOOP, FINISH, SRATE#DEFINE ”≈—ØÕ¡…Œ = 0#DEFINE ”≈—Ø”≈Ã≈√‘Ø”¡Õ–Ã≈ = 1#DEFINE ‘…Õ≈«¡– = .05'----.INIT'----  STATE$(0) = "MAIN:   "  STATE$(1) = "FSTART: "  STATE$(2) = "FPLAYBK:"  STATE$(3) = "FLOOP:  "  STATE$(4) = "FEND:   "  OLDØFRAME(∆“ÕØ”‘¡“‘) = -1  OLDØFRAME(∆“ÕØ–Ã¡Ÿ¬¡√À) = -1  OLDØFRAME(∆“ÕØÃœœ–) = -1  OLDØFRAME(∆“ÕØ≈Œƒ) = -1  ”¡Õ–Ã≈ SAMPLE(5) = [ _    [ "GET", 1, 0,     1631,  2091,  3700, $19E4 ], _    [ "TO",  0, 3700,  0,     0,     5710, $1CA0 ], _    [ "THE", 0, 5800,  0,     0,     8000, $1C64 ], _    [ "CHO", 1, 8701,  11334, 12100, 14200, $1C3C ], _    [ "PER", 1, 14301, 16830, 17796, 26914, $1C6E ], _    [ "ALL", 0, 0,     0,     0,     26914, $19E4 ] _  ]  NOTEØKEY$(0)  = "A"  ' C  NOTEØKEY$(1)  = "W"  ' C#  NOTEØKEY$(2)  = "S"  ' D  NOTEØKEY$(3)  = "E"  ' D#  NOTEØKEY$(4)  = "D"  ' E  NOTEØKEY$(5)  = "F"  ' F  NOTEØKEY$(6)  = "T"  ' F#  NOTEØKEY$(7)  = "G"  ' G  NOTEØKEY$(8)  = "Y"  ' G#  NOTEØKEY$(9)  = "H"  ' A  NOTEØKEY$(10) = "U"  ' A#  NOTEØKEY$(11) = "J"  ' B  NOTEMAP(0) = 0  ' C  NOTEMAP(1) = 2  ' D  NOTEMAP(2) = 4  ' E  NOTEMAP(3) = 5  ' F  NOTEMAP(4) = 7  ' G  NOTEMAP(5) = 9  ' A  NOTEMAP(6) = 11 ' B    SHARPNOTEMAP(0) = 1  ' C#  SHARPNOTEMAP(1) = 3  ' D#  SHARPNOTEMAP(2) = 5  ' E# = F  SHARPNOTEMAP(3) = 6  ' F#  SHARPNOTEMAP(4) = 8  ' G#  SHARPNOTEMAP(5) = 10 ' A#  SHARPNOTEMAP(6) = 11 ' B# (OUGHT TO BE HIGH C, BUT LET'S IGNORE IT FOR NOW)  VOL 3,3  TEMPO 20  ENVELOPE 6, 0, 9, 0, 0  ENVELOPE 7, 0, 9, 9, 0  PLAY "T6O1 IAAAAAA AAAAAA L",,,"T7IO2AO3EGAO4CO3GAEGDEG L"  ' V$ = "I%0E%1E%2E%3E%4E %2E%3E%4E %2E%3E%4E %2E"  V$ = "I -%0E %1B + %2D %3E %4G %2D %3F - %4B +%2D -%3A %4B +%2D"'----.MAIN'----  BLOAD "CHOPPER16K.RAW",P($50000)  GOSUB SEQUENCER  GOSUB PIANOØMODE  GOSUB INITØSCREEN  GOSUB DRAWØAUDIO  MOUSE ON, 1, 0  DMODE 0, 1, 0, 0, 0  GOSUB GETØINPUT  SCREEN CLOSE  MOUSE OFF  END'---------.SEQUENCER'---------  PRINT CHR$(147);  MYTEMPO = 20  ' WHOLE NOTE DURATION = 24 / TEMPOVALUE  ' SIXTEENTH NOTE = 24 / TEMPOVALUE / 16  DTØDIGI = 24 / MYTEMPO / 16  DO WHILE 1    DURATION = 4  ' DEFAULT TO QUARTER NOTE    SHARPØFLAG = 0    DOTTEDØFLAG = 0    OCTAVE = 0    AUDIOIDX = 1    ISØDIGIØPLAYING = 0    ISØREST = 0    PRINT "ì? ";V$        INPUT "";V$    SEQSTATE = ”≈—ØÕ¡…Œ    TIMEØDURATION = TI    DO WHILE AUDIOIDX <> -1      GOSUB POLLØDIGIS    LOOP  LOOP  RETURN'----------.POLLØDIGIS'----------  ' PARSE AND PLAY THE AUDIO STRING  IF ISØDIGIØPLAYING THEN BEGIN    ' PRINT "TI-DIGIØSTART = ";TI-DIGIØSTART    ' PRINT "TIMEØDURATION = ";TIMEØDURATION    IF TI >= TIMEØDURATION THEN BEGIN      IF NOT ISØREST AND SAMPLEØLOOPING(SIDX) THEN GOSUB ENDØAUDIOØLOOPING      ISØDIGIØPLAYING = 0      ISØREST = 0    BEND : ELSE BEGIN      RETURN    BEND  BEND  IF AUDIOIDX > LEN(V$) THEN AUDIOIDX = -1 : RETURN  CH$ = MID$(V$, AUDIOIDX, 1)  IF SEQSTATE = ”≈—ØÕ¡…Œ THEN BEGIN    IF CH$ = "%" THEN SEQSTATE = ”≈—Ø”≈Ã≈√‘Ø”¡Õ–Ã≈    IF CH$ = "#" THEN SHARPØFLAG = 1    IF CH$ = "." THEN DOTTEDØFLAG = 1    IF CH$ = "-" THEN OCTAVE = OCTAVE - 1    IF CH$ = "+" THEN OCTAVE = OCTAVE + 1    IF CH$ >= "A" AND CH$ <= "G" THEN BEGIN      IF CH$ >= "C" THEN K = ASC(CH$) - ASC("C")      IF CH$ = "A" THEN K = 5      IF CH$ = "B" THEN K = 6      SRATE = SAMPLEØSRATE(SIDX)      IF SHARPØFLAG THEN BEGIN        SRATE = SRATE * DTØSEMI ^ (SHARPNOTEMAP(K) + OCTAVE * 12)      BEND : ELSE BEGIN        SRATE = SRATE * DTØSEMI ^ (NOTEMAP(K) + OCTAVE * 12)      BEND      SHARPØFLAG = 0      DIGIØSTART = TI      ISØDIGIØPLAYING = 1      GOSUB PLAYØWITHØSRATE      IF DOTTEDØFLAG THEN BEGIN        TIMEØDURATION = TIMEØDURATION + DTØDIGI * DURATION * 1.5      BEND : ELSE BEGIN        TIMEØDURATION = TIMEØDURATION + DTØDIGI * DURATION      BEND      DOTTEDØFLAG = 0    BEND    IF CH$ = "S" THEN DURATION = 1    IF CH$ = "I" THEN DURATION = 2    IF CH$ = "Q" THEN DURATION = 4    IF CH$ = "H" THEN DURATION = 8    IF CH$ = "W" THEN DURATION = 16    IF CH$ = "R" THEN BEGIN      ISØREST = 1      IF DOTTEDØFLAG THEN BEGIN        TIMEØDURATION = TIMEØDURATION + DTØDIGI * DURATION * 1.5      BEND : ELSE BEGIN        TIMEØDURATION = TIMEØDURATION + DTØDIGI * DURATION      BEND    BEND  BEND : GOTO SKIPØSEQ  IF SEQSTATE = ”≈—Ø”≈Ã≈√‘Ø”¡Õ–Ã≈ THEN BEGIN    SIDX = VAL(CH$)    ' PRINT "SIDX=";SIDX;"(";CH$;")"    SEQSTATE = ”≈—ØÕ¡…Œ  BEND.SKIPØSEQ  AUDIOIDX = AUDIOIDX + 1  RETURN'----------.PIANOØMODE'----------  DO WHILE 1    GET KEY A$    IF A$ >= "1" AND A$ <= "6" THEN SIDX = ASC(A$) - ASC("1") : GOSUB PLAYØWITHØINFO    IF A$ = "," THEN SAMPLEØSRATE(SIDX) = SAMPLEØSRATE(SIDX) - 1 : GOSUB PLAYØWITHØINFO    IF A$ = "." THEN SAMPLEØSRATE(SIDX) = SAMPLEØSRATE(SIDX) + 1 : GOSUB PLAYØWITHØINFO    IF A$ = "<" THEN SAMPLEØSRATE(SIDX) = SAMPLEØSRATE(SIDX) - 50 : GOSUB PLAYØWITHØINFO    IF A$ = ">" THEN SAMPLEØSRATE(SIDX) = SAMPLEØSRATE(SIDX) + 50 : GOSUB PLAYØWITHØINFO        IF A$ = ";" THEN BEGIN      OCTAVE = OCTAVE - 1      PRINT "OCTAVE =";OCTAVE    BEND    IF A$ = ":" THEN BEGIN      OCTAVE = OCTAVE + 1      PRINT "OCTAVE =";OCTAVE    BEND    IF A$ = "@" THEN BEGIN      OCTAVE = OCTAVE - .02      PRINT "OCTAVE =";OCTAVE    BEND    IF A$ = "*" THEN BEGIN      OCTAVE = OCTAVE + .2      PRINT "OCTAVE =";OCTAVE    BEND    GOSUB CHECKØNOTES    IF A$ = "X" THEN END  LOOP  RETURN'-----------.CHECKØNOTES'-----------  FOR K = 0 TO 11    IF A$ = NOTEØKEY$(K) THEN BEGIN      SRATE = SAMPLEØSRATE(SIDX)      SRATE = SRATE * DTØSEMI ^ (K + OCTAVE * 12)      GOSUB PLAYØWITHØSRATE    BEND  NEXT K  RETURN'--------------.PLAYØWITHØINFO'--------------  ' PRINT "SAMPLE#";MID$(STR$(SIDX),2);" @ ";HEX$(SAMPLEØSRATE(SIDX))  GOSUB PLAYØSAMPLEØAUDIO  RETURN'--------------.PLAYØWITHØSRATE'--------------  ' PRINT "SAMPLE#";MID$(STR$(SIDX),2);" @ ";HEX$(SRATE)  GOSUB PLAYØVARØSRATE  RETURN'---------.DRAWØINFO'---------  A$ = STATE$(STATE) + "FSTART =" _    + STR$(FRAME(∆“ÕØ”‘¡“‘)) _    + ", FPLAYBK =" + STR$(FRAME(∆“ÕØ–Ã¡Ÿ¬¡√À)) _    + ", FLOOP = " + STR$(FRAME(∆“ÕØÃœœ–)) _    + ", FEND =" + STR$(FRAME(∆“ÕØ≈Œƒ))  XPOS = 0 : YPOS = 0  GOSUB DRAWØTEXT  IF STATE >= ”‘¡‘≈Ø∆”‘¡“‘ AND STATE <= ”‘¡‘≈Ø∆≈Œƒ THEN BEGIN    V = WPEEK($50000 + FRAME(STATE - 1) * 2)    IF V AND 32768 THEN V = V - 65535    A$ = "SAMPLE = " + STR$(V)    XPOS = 0 : YPOS = 1    GOSUB DRAWØTEXT    IF OLDØFRAME(STATE-1) <> -1 THEN BEGIN      LINE OLDØFRAME(STATE-1), 16, OLDØFRAME(STATE-1), 399    BEND    T = FRAME(STATE-1) * 640 / (◊¡÷Ø”…⁄≈ / 2)    LINE T, 16, T, 399    OLDØFRAME(STATE-1) = T  BEND  RETURN'---------.GETØINPUT'---------  DO WHILE 1    GOSUB DRAWØINFO    GET KEY A$    IF A$ = "1" THEN STATE = ”‘¡‘≈Ø∆”‘¡“‘    IF A$ = "2" THEN STATE = ”‘¡‘≈Ø∆–Ã¡Ÿ¬¡√À    IF A$ = "3" THEN STATE = ”‘¡‘≈Ø∆Ãœœ–    IF A$ = "4" THEN STATE = ”‘¡‘≈Ø∆≈Œƒ    IF A$ = "P" THEN GOSUB PLAYØAUDIO     IF A$ = ">" THEN GOSUB BIGØINCR    IF A$ = "<" THEN GOSUB BIGØDECR    IF A$ = "." THEN GOSUB LITTLEØINCR    IF A$ = "," THEN GOSUB LITTLEØDECR    IF A$ = "X" THEN EXIT  LOOP  RETURN'--------.BIGØINCR'--------  IF STATE = ”‘¡‘≈ØÕ¡…Œ THEN RETURN  FRAME(STATE-1) = FRAME(STATE-1) + 100  IF FRAME(STATE-1) > (◊¡÷Ø”…⁄≈ / 2) THEN FRAME(STATE-1) = ◊¡÷Ø”…⁄≈/2-1  RETURN'--------.BIGØDECR'--------  IF STATE = ”‘¡‘≈ØÕ¡…Œ THEN RETURN  FRAME(STATE-1) = FRAME(STATE-1) - 100  IF FRAME(STATE-1) < 0 THEN FRAME(STATE-1) = 0  RETURN'-----------.LITTLEØINCR'-----------  IF STATE = ”‘¡‘≈ØÕ¡…Œ THEN RETURN  FRAME(STATE-1) = FRAME(STATE-1) + 1  IF FRAME(STATE-1) > (◊¡÷Ø”…⁄≈ / 2) THEN FRAME(STATE-1) = ◊¡÷Ø”…⁄≈/2-1  RETURN'-----------.LITTLEØDECR'-----------  IF STATE = ”‘¡‘≈ØÕ¡…Œ THEN RETURN  FRAME(STATE-1) = FRAME(STATE-1) - 1  IF FRAME(STATE-1) < 0 THEN FRAME(STATE-1) = 0  RETURN'---------.DRAWØTEXT'---------  ' CLEAR PRIOR TEXT  CHAR XPOS, YPOS*8, 1, 1, 2, CHR$(2)+"                                                                     "  CHAR XPOS, YPOS*8, 1, 1, 2, A$  RETURN'-----------.INITØSCREEN'-----------  SCREEN 0, 640, 400, 1  PEN 1  RETURN'----------.DRAWØAUDIO'----------  T = 0  OLDX = 0  OLDY = 200  DT = 640 / 26915  FOR K = $50000 TO $5D246 STEP 2    V = WPEEK(K)    IF V AND 32768 THEN V = V - 65535    'PRINT V    'GET KEY A$    V = V * 200 / 32768 + 200    LINE OLDX, OLDY, T, V    OLDX = T    OLDY = V    T = (K - $50000) / 2 * 640 / 26915  NEXT K  RETURN'---------------------.PLAYØAUDIOØFROMØFRAME'---------------------  FSTART = FRAME(∆“ÕØ”‘¡“‘)  FPLAYBACK = FRAME(∆“ÕØ–Ã¡Ÿ¬¡√À)  FLOOP = FRAME(∆“ÕØÃœœ–)  FEND = FRAME(∆“ÕØ≈Œƒ)  LOOPING = 1  SRATE = $19E4  GOSUB PLAYØAUDIO  RETURN'-----------------.PLAYØSAMPLEØAUDIO'-----------------  SRATE = SAMPLEØSRATE(SIDX)  GOSUB PLAYØVARØSRATE  RETURN'--------------.PLAYØVARØSRATE'--------------  FSTART = SAMPLEØSTART%(SIDX)  FPLAYBACK = SAMPLEØPLAYBACK(SIDX)  FLOOP = SAMPLEØLOOP(SIDX)  FEND = SAMPLEØFINISH(SIDX)  LOOPING = SAMPLEØLOOPING(SIDX)  GOSUB PLAYØAUDIO  RETURN'----------.PLAYØAUDIO'----------  ' SWITCH OFF DIGI CHANNEL 0  POKE $D720, 0  ' ENABLE AUDIO DMA  SETBIT $D711, 7  ' SAMPLE STARTS AT $5.0000  V = FPLAYBACK * 2  POKE $D721, V AND 255  POKE $D722, V / 256  POKE $D723, $05  ' SET PLAYHEAD TO BEGINNING  V = FSTART * 2  POKE $D72A, V AND 255  POKE $D72B, V / 256  POKE $D72C, $05  ' END (LOOP-POINT) OF SAMPLE  IF LOOPING THEN V = FLOOP * 2 : ELSE V = FEND * 2  WPOKE $D727, V  ' SET DIGI CH0 L/R VOLUMES  POKE $D71C,$66 : POKE $D729, $66  ' SAMPLEØRATE = (16000 * 2^24) / (40.5 * 10^6) = 6628 = $19≈4  ' SAMPLE RATE 16K»Z  POKE $D724, SRATE AND 255  POKE $D725, (SRATE / 256) AND 255  POKE $D726, (SRATE / 65536) AND 255  ' PLAY UNSIGNED 16-BIT SOUND WITH LOOPING  K = $80 + $03  IF LOOPING THEN K = K + $40  POKE $D720, K  RETURN'-----------------.ENDØAUDIOØLOOPING'-----------------  ' SWITCH IT OFF!  ' --------------  ' END (LOOP-POINT) OF SAMPLE  V = FEND * 2  WPOKE $D727, V  ' PLAY UNSIGNED 16-BIT SOUND WITHOUT LOOPING  POKE $D720, $80 + $00 + $03  RETURN