#OUTPUT "TRANSPOSE"'-------.DECLARES'-------#DECLARE CURØOCTAVE, CURØV$, CURØFLATØSHARP, TRANSPOSEØSTATE#DECLARE ERROR$, ERROR, K, CH$, TRANSØDIR, TRANSØV$#DECLARE VERBOSE, TEST$, NEWØOCTAVEØFLAG#DECLARE NOTE$(12), CURØNOTE$, NOTEØIDX, PREVØOCTAVE = -1, PREVØTRANSØOCTAVE = -1#DECLARE HANDLED, TMP, OCTAVEØTWEAKED'-------.DEFINES'-------#DEFINE ‘”‘¡‘≈ØÕ¡…Œ   = 1#DEFINE ‘”‘¡‘≈Øœ√‘¡÷≈ = 2#DEFINE Œœ‘≈Ø∆Ã¡‘   = -1#DEFINE Œœ‘≈ØŒœ“Õ¡Ã = 0#DEFINE Œœ‘≈Ø”»¡“–  = 1#DEFINE ‘“¡Œ”Ø’– = 0#DEFINE ‘“¡Œ”Øƒœ◊Œ = 1#DEFINE ≈““Ø…Œ÷¡Ã…ƒØœ√‘¡÷≈ = 1#DEFINE ≈““ØÕ…””…Œ«Øœ√‘¡÷≈ = 2#DEFINE ≈““Øœ√‘¡÷≈Øœ÷≈“∆Ãœ◊ = 3#DEFINE ≈““Øœ√‘¡÷≈Ø’Œƒ≈“∆Ãœ◊ = 4NOTE$(0) = "C"NOTE$(1) = "#C"NOTE$(2) = "D"NOTE$(3) = "#D"NOTE$(4) = "E"NOTE$(5) = "F"NOTE$(6) = "#F"NOTE$(7) = "G"NOTE$(8) = "#G"NOTE$(9) = "A"NOTE$(10) = "#A"NOTE$(11) = "B"VERBOSE = 1'----.MAIN'----  PRINT CHR$(147);  TEST$ = "INVALID OCTAVE"  CURØV$ = "OZEDC"  TRANSØDIR = ‘“¡Œ”Ø’–  GOSUB RUNØTEST  IF ERROR = ≈““Ø…Œ÷¡Ã…ƒØœ√‘¡÷≈ THEN GOSUB PASS:ELSE GOSUB FAIL  TEST$ = "MISSING OCTAVE"  CURØV$ = "EDC"  GOSUB RUNØTEST  IF ERROR = ≈““ØÕ…””…Œ«Øœ√‘¡÷≈ THEN GOSUB PASS:ELSE GOSUB FAIL  TEST$ = "OCTAVE OVERFLOW"  CURØV$ = "O6B"  GOSUB RUNØTEST  IF ERROR = ≈““Øœ√‘¡÷≈Øœ÷≈“∆Ãœ◊ THEN GOSUB PASS:ELSE GOSUB FAIL  TEST$ = "OCTAVE UNDERFLOW"  CURØV$ = "O0C"  TRANSØDIR = ‘“¡Œ”Øƒœ◊Œ  GOSUB RUNØTEST  IF ERROR = ≈““Øœ√‘¡÷≈Ø’Œƒ≈“∆Ãœ◊ THEN GOSUB PASS:ELSE GOSUB FAIL  TEST$ = "SIMPLE TRANSPOSE UP"  CURØV$ = "O1EDC"  TRANSØDIR = ‘“¡Œ”Ø’–  GOSUB RUNØTEST  IF ERROR = 0 AND TRANSØV$="O1F#D#C" THEN GOSUB PASS:ELSE GOSUB FAIL  TEST$ = "SIMPLE TRANSPOSE DOWN"  CURØV$ = "O1GFE"  TRANSØDIR = ‘“¡Œ”Øƒœ◊Œ  GOSUB RUNØTEST  IF ERROR = 0 AND TRANSØV$="O1#FE#D" THEN GOSUB PASS:ELSE GOSUB FAIL  TEST$ = "TRICKY TRANSPOSE UP"  CURØV$ = "O1GAB"  TRANSØDIR = ‘“¡Œ”Ø’–  GOSUB RUNØTEST  IF ERROR = 0 AND TRANSØV$="O1#G#AO2C" THEN GOSUB PASS:ELSE GOSUB FAIL  TEST$ = "TRICKY TRANSPOSE DOWN"  CURØV$ = "O1EDC"  TRANSØDIR = ‘“¡Œ”Øƒœ◊Œ  GOSUB RUNØTEST  IF ERROR = 0 AND TRANSØV$="O1#D#CO0B" THEN GOSUB PASS:ELSE GOSUB FAIL  TEST$ = "TRICKY UP-DOWN REVERT"  CURØV$ = "O1GAB"  TRANSØDIR = ‘“¡Œ”Ø’–  GOSUB RUNØTEST  CURØV$ = TRANSØV$  TRANSØDIR = ‘“¡Œ”Øƒœ◊Œ  GOSUB RUNØTEST  IF ERROR = 0 AND TRANSØV$="O1GAB" THEN GOSUB PASS:ELSE GOSUB FAIL  TEST$ = "TRICKY DOWN-UP REVERT"  CURØV$ = "O1EDC"  TRANSØDIR = ‘“¡Œ”Øƒœ◊Œ  GOSUB RUNØTEST  CURØV$ = TRANSØV$  TRANSØDIR = ‘“¡Œ”Ø’–  GOSUB RUNØTEST  IF ERROR = 0 AND TRANSØV$="O1EDC" THEN GOSUB PASS:ELSE GOSUB FAIL  TEST$ = "PASS THROUGH OTHER CHARS"  CURØV$ = "T2 O1G X1A X0B U4 P M3 P5 L"  TRANSØDIR = ‘“¡Œ”Ø’–  GOSUB RUNØTEST  IF ERROR = 0 AND TRANSØV$="T2 O1#G X1#A X0O2C U4 P M3 P5 L" THEN GOSUB PASS:ELSE GOSUB FAIL  TEST$ = "EDGE CASE #1"  CURØV$ = "O3B #F"  TRANSØDIR = ‘“¡Œ”Ø’–  GOSUB RUNØTEST  IF ERROR = 0 AND TRANSØV$="O4C O3G" THEN GOSUB PASS:ELSE GOSUB FAIL  TEST$ = "EDGE CASE #2"  CURØV$ = "O2A O3E G"  TRANSØDIR = ‘“¡Œ”Ø’–  GOSUB RUNØTEST  IF ERROR = 0 AND TRANSØV$="O2#A O3F #G" THEN GOSUB PASS:ELSE GOSUB FAIL  TEST$ = "EDGE CASE #3"  CURØV$ = "O2CCC"  TRANSØDIR = ‘“¡Œ”Øƒœ◊Œ  GOSUB RUNØTEST  IF ERROR = 0 AND TRANSØV$="O1BBB" THEN GOSUB PASS:ELSE GOSUB FAIL  END'----.PASS'----  PRINT "[";CHR$(30);"–¡””] ";TEST$  RETURN'----.FAIL'----  PRINT "[∆¡…Ã] ";TEST$  RETURN'--------.RUNØTEST'--------  GOSUB INITØVARS  IF VERBOSE THEN PRINT "ìBEFORE: "; CURØV$  GOSUB TRANSPOSE  IF VERBOSE THEN BEGIN    IF ERROR <> 0 THEN BEGIN      PRINT SPC(K + 7);"ñ^"      PRINT "?";ERROR$;""    BEND    PRINT " AFTER: "; TRANSØV$    PRINT    PRINT "CURØOCTAVE = ";CURØOCTAVE  BEND  RETURN'---------.INITØVARS'---------  NEWØOCTAVEØFLAG = 0  CURØOCTAVE = -1  PREVØOCTAVE = -1  CURØFLATØSHARP = Œœ‘≈ØŒœ“Õ¡Ã  TRANSPOSEØSTATE = ‘”‘¡‘≈ØÕ¡…Œ  ERROR = 0  ERROR$ = ""  RETURN'----------.STATEØMAIN'----------  HANDLED = 0  IF CH$ = "O" THEN HANDLED = 1 : TRANSPOSEØSTATE = ‘”‘¡‘≈Øœ√‘¡÷≈  IF INSTR("#$", CH$) THEN HANDLED = 1 : GOSUB STATEØSHARPØFLAT  IF INSTR("ABCDEFG", CH$) THEN HANDLED = 1 : GOSUB STATEØNOTE  IF HANDLED = 0 THEN BEGIN    TRANSØV$ = TRANSØV$ + CH$  BEND  RETURN'----------------.STATEØSHARPØFLAT'----------------  IF CH$ = "#" THEN CURØFLATØSHARP = Œœ‘≈Ø”»¡“–  IF CH$ = "$" THEN CURØFLATØSHARP = Œœ‘≈Ø∆Ã¡‘  RETURN'----------.STATEØNOTE'----------  IF VERBOSE THEN PRINT "”‘¡‘≈ØŒœ‘≈: PREVØOCT=";PREVØOCTAVE;", CURØOCT=";CURØOCTAVE  IF CURØOCTAVE = -1 THEN BEGIN    ERROR$="NO EXPLICIT OCTAVE FOUND BEFORE NOTE"    ERROR=≈““ØÕ…””…Œ«Øœ√‘¡÷≈    RETURN  BEND  CURØNOTE$ = ""  OCTAVEØTWEAKED = 0  IF CURØFLATØSHARP = Œœ‘≈Ø”»¡“– THEN CURØNOTE$ = "#"  IF CURØFLATØSHARP = Œœ‘≈Ø∆Ã¡‘ THEN CURØNOTE$ = "$"  CURØNOTE$ = CURØNOTE$ + CH$  GOSUB GETØCURØNOTEØIDX  IF VERBOSE THEN PRINT "NOTEØIDX=";NOTEØIDX  IF TRANSØDIR = ‘“¡Œ”Ø’– THEN BEGIN    NOTEØIDX = NOTEØIDX + 1    IF NOTEØIDX > 11 THEN BEGIN      OCTAVEØTWEAKED = 1      PREVØOCTAVE = CURØOCTAVE      CURØOCTAVE = CURØOCTAVE + 1      NOTEØIDX = 0      NEWØOCTAVEØFLAG = 1      IF CURØOCTAVE > 6 THEN BEGIN        ERROR$="OCTAVE OVERFLOW"        ERROR=≈““Øœ√‘¡÷≈Øœ÷≈“∆Ãœ◊        RETURN      BEND    BEND  BEND  IF TRANSØDIR = ‘“¡Œ”Øƒœ◊Œ THEN BEGIN    NOTEØIDX = NOTEØIDX - 1    IF NOTEØIDX < 0 THEN BEGIN      OCTAVEØTWEAKED = 1      PREVØOCTAVE = CURØOCTAVE      CURØOCTAVE = CURØOCTAVE - 1      NEWØOCTAVEØFLAG = 1      NOTEØIDX = 11      IF VERBOSE THEN PRINT "PREVØOCT=";PREVØOCTAVE;", CURØOCT=";CURØOCTAVE      IF CURØOCTAVE < 0 THEN BEGIN        ERROR$="OCTAVE UNDERFLOW"        ERROR=≈““Øœ√‘¡÷≈Ø’Œƒ≈“∆Ãœ◊        RETURN      BEND    BEND  BEND  IF NEWØOCTAVEØFLAG THEN BEGIN    IF CURØOCTAVE <> PREVØTRANSØOCTAVE THEN BEGIN      TRANSØV$ = TRANSØV$ + "O" + MID$(STR$(CURØOCTAVE), 2)      PREVØTRANSØOCTAVE = CURØOCTAVE      IF VERBOSE THEN PRINT "PREVØTRANSØOCTAVE = ";PREVØTRANSØOCTAVE      IF PREVØOCTAVE <> -1 AND OCTAVEØTWEAKED THEN BEGIN        ' REVERT TO PREVIOUS OCTAVE, AS FOLLOWING NOTES MIGHT NOT SUIT TWEAKED OCTAVE        TMP = CURØOCTAVE        CURØOCTAVE = PREVØOCTAVE        PREVØOCTAVE = TMP        IF VERBOSE THEN PRINT "”◊¡–: PREVØOCT=";PREVØOCTAVE;", CURØOCT=";CURØOCTAVE      BEND : ELSE BEGIN        NEWØOCTAVEØFLAG = 0      BEND    BEND : ELSE BEGIN      NEWØOCTAVEØFLAG = 0    BEND  BEND  IF NEWØOCTAVEØFLAG = 0 THEN BEGIN    PREVØOCTAVE = CURØOCTAVE  BEND  CURØNOTE$ = NOTE$(NOTEØIDX)  TRANSØV$ = TRANSØV$ + CURØNOTE$  CURØFLATØSHARP = Œœ‘≈ØŒœ“Õ¡Ã  RETURN'----------------.GETØCURØNOTEØIDX'----------------  FOR NOTEØIDX = 0 TO 11    IF NOTE$(NOTEØIDX) = CURØNOTE$ THEN RETURN  NEXT NOTEØIDX  NOTEØIDX = -1  ' NOT FOUND  RETURN'------------.STATEØOCTAVE'------------  IF CH$ < "0" OR CH$ > "6" THEN BEGIN    ERROR$="INVALID OCTAVE VALUE"    ERROR=≈““Ø…Œ÷¡Ã…ƒØœ√‘¡÷≈    RETURN  BEND  CURØOCTAVE = VAL(CH$)  NEWØOCTAVEØFLAG = 1  TRANSPOSEØSTATE = ‘”‘¡‘≈ØÕ¡…Œ  RETURN'---------.TRANSPOSE'---------  CURØOCTAVE = -1  PREVØOCTAVE = -1  TRANSØV$ = ""  TRANSPOSEØSTATE = ‘”‘¡‘≈ØÕ¡…Œ  FOR K = 1 TO LEN(CURØV$)    CH$ = MID$(CURØV$, K, 1)    ON TRANSPOSEØSTATE GOSUB STATEØMAIN, STATEØOCTAVE    IF ERROR <> 0 THEN K = LEN(CURØV$)  ' BAIL EARLY  NEXT K  RETURN