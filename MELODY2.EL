' CONTINUATION OF 'MELODY.EL' FILE...'----------.STATEØMAIN'----------  HANDLED = 0  IF CH$ = "O" THEN HANDLED = 1 : TRANSPOSEØSTATE = ‘”‘¡‘≈Øœ√‘¡÷≈  IF INSTR("#$", CH$) THEN HANDLED = 1 : GOSUB STATEØSHARPØFLAT  IF INSTR("ABCDEFG", CH$) THEN HANDLED = 1 : GOSUB STATEØNOTE  IF HANDLED = 0 THEN BEGIN    TRANSØV$ = TRANSØV$ + CH$  BEND    IF VERBOSE THEN PRINT "TRANSØV$ = ";TRANSØV$  RETURN'----------------.STATEØSHARPØFLAT'----------------  IF CH$ = "#" THEN CURØFLATØSHARP = Œœ‘≈Ø”»¡“–  IF CH$ = "$" THEN CURØFLATØSHARP = Œœ‘≈Ø∆Ã¡‘  RETURN'----------.STATEØNOTE'----------  IF VERBOSE THEN PRINT "”‘¡‘≈ØŒœ‘≈:"  IF CURØOCTAVE = -1 THEN BEGIN    ERROR$="NO EXPLICIT OCTAVE FOUND BEFORE NOTE"    ERROR=≈““ØÕ…””…Œ«Øœ√‘¡÷≈    RETURN  BEND  CURØNOTE$ = ""  OCTAVEØTWEAKED = 0  IF CURØFLATØSHARP = Œœ‘≈Ø”»¡“– THEN CURØNOTE$ = "#"  IF CURØFLATØSHARP = Œœ‘≈Ø∆Ã¡‘ THEN CURØNOTE$ = "$"  CURØNOTE$ = CURØNOTE$ + CH$  GOSUB GETØCURØNOTEØIDX  IF VERBOSE THEN PRINT "NOTEØIDX=";NOTEØIDX  IF TRANSØDIR = ‘“¡Œ”Ø’– THEN BEGIN    NOTEØIDX = NOTEØIDX + 1    IF NOTEØIDX > 11 THEN BEGIN      OCTAVEØTWEAKED = 1      PREVØOCTAVE = CURØOCTAVE      CURØOCTAVE = CURØOCTAVE + 1      NEWØOCTAVEØFLAG = 1      NOTEØIDX = 0      IF VERBOSE THEN PRINT "PREVØOCT=";PREVØOCTAVE;", CURØOCT=";CURØOCTAVE      IF CURØOCTAVE > 6 THEN BEGIN        ERROR$="OCTAVE OVERFLOW"        ERROR=≈““Øœ√‘¡÷≈Øœ÷≈“∆Ãœ◊        RETURN      BEND    BEND  BEND  IF TRANSØDIR = ‘“¡Œ”Øƒœ◊Œ THEN BEGIN    NOTEØIDX = NOTEØIDX - 1    IF NOTEØIDX < 0 THEN BEGIN      OCTAVEØTWEAKED = 1      PREVØOCTAVE = CURØOCTAVE      CURØOCTAVE = CURØOCTAVE - 1      NEWØOCTAVEØFLAG = 1      NOTEØIDX = 11      IF VERBOSE THEN PRINT "PREVØOCT=";PREVØOCTAVE;", CURØOCT=";CURØOCTAVE      IF CURØOCTAVE < 0 THEN BEGIN        ERROR$="OCTAVE UNDERFLOW"        ERROR=≈““Øœ√‘¡÷≈Ø’Œƒ≈“∆Ãœ◊        RETURN      BEND    BEND  BEND  IF CURØOCTAVE <> PREVØTRANSØOCTAVE OR PREVØOCTAVE = -1 THEN BEGIN    TRANSØV$ = TRANSØV$ + "O" + MID$(STR$(CURØOCTAVE), 2)    PREVØTRANSØOCTAVE = CURØOCTAVE  BEND      IF VERBOSE THEN PRINT "PREVØTRANSØOCTAVE = ";PREVØTRANSØOCTAVE  IF PREVØOCTAVE <> -1 AND OCTAVEØTWEAKED THEN BEGIN    ' REVERT TO PREVIOUS OCTAVE, AS FOLLOWING NOTES MIGHT NOT SUIT TWEAKED OCTAVE    TMP = CURØOCTAVE    CURØOCTAVE = PREVØOCTAVE    PREVØOCTAVE = TMP    IF VERBOSE THEN PRINT "”◊¡–: PREVØOCT=";PREVØOCTAVE;", CURØOCT=";CURØOCTAVE  BEND  NEWØOCTAVEØFLAG = 0  PREVØOCTAVE = CURØOCTAVE  CURØNOTE$ = NOTE$(NOTEØIDX)  TRANSØV$ = TRANSØV$ + CURØNOTE$  CURØFLATØSHARP = Œœ‘≈ØŒœ“Õ¡Ã  RETURN'----------------.GETØCURØNOTEØIDX'----------------  FOR NOTEØIDX = 0 TO 11    IF NOTE$(NOTEØIDX) = CURØNOTE$ THEN RETURN  NEXT NOTEØIDX  NOTEØIDX = -1  ' NOT FOUND  RETURN'------------.STATEØOCTAVE'------------  IF CH$ < "0" OR CH$ > "6" THEN BEGIN    ERROR$="INVALID OCTAVE VALUE"    ERROR=≈““Ø…Œ÷¡Ã…ƒØœ√‘¡÷≈    RETURN  BEND  CURØOCTAVE = VAL(CH$)  NEWØOCTAVEØFLAG = 1  TRANSPOSEØSTATE = ‘”‘¡‘≈ØÕ¡…Œ  RETURN'---------.TRANSPOSE'---------' TESTED IN FILE: "TRANSPOSE.EL"  CURØOCTAVE = -1  PREVØOCTAVE = -1  PREVØTRANSØOCTAVE = -1  TRANSØV$ = ""  TRANSPOSEØSTATE = ‘”‘¡‘≈ØÕ¡…Œ  ERROR = 0  NEWØOCTAVEØFLAG = 0  FOR K = 1 TO LEN(CURØV$)    CH$ = MID$(CURØV$, K, 1)    IF VERBOSE THEN PRINT "TRANSPOSEØSTATE = ";TRANSPOSEØSTATE;    IF VERBOSE THEN PRINT ", CH$=";CH$    ON TRANSPOSEØSTATE GOSUB STATEØMAIN, STATEØOCTAVE    IF ERROR <> 0 THEN K = LEN(CURØV$)  ' BAIL EARLY  NEXT K  RETURN