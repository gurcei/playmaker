' CONTINUATION OF 'MELODY.EL' FILE....STOPØALLØMUSIC'--------------  PLYPTR = -1  PLYFLAG = 0  PLAY:PLAY ""  GOSUB SETØALLØENV  TEMPO TMPO%  GOSUB APPLYØSELECTEDØFILTER  RETURN.DELETEØCHUNKØSEQ'----------------  IF SEQCNT = 0 THEN RETURN  K = SEQPTR  DO WHILE K < SEQCNT - 1    SEQØCHUNK(K) = SEQØCHUNK(K + 1)    SEQØEXTRA(K) = SEQØEXTRA(K + 1)    K = K + 1  LOOP  SEQCNT = SEQCNT - 1  IF SEQPTR = SEQCNT AND SEQPTR>0 THEN SEQPTR = SEQPTR - 1  RETURN.EDITØCHUNKØSEQ'--------------  IF SEQCNT = 0 THEN RETURN  PRINT À≈ŸØ»œÕ≈;À≈ŸØ‘¡¬;À≈ŸØ‘¡¬;À≈ŸØ≈”√¡–≈;"Q";  V=0:INPUT "CHUNK#: ", V  SEQØCHUNK(SEQPTR) = V  PRINT À≈ŸØ»œÕ≈;À≈ŸØ‘¡¬;À≈ŸØ‘¡¬;À≈ŸØ≈”√¡–≈;"Q";  V=-1:INPUT "EXTRA#: ", V  SEQØEXTRA(SEQPTR) = V  RETURN.EDITØCHUNKØCELL'---------------  IF SEQCNT = 0 THEN RETURN  PRINT À≈ŸØ»œÕ≈;À≈ŸØ‘¡¬;À≈ŸØ‘¡¬;À≈ŸØ≈”√¡–≈;"Q";  IF SSCOL = 0 THEN BEGIN    V = SEQØCHUNK(SEQPTR)    V1$ = STR$(V)    IF LEFT$(V1$,1) = " " THEN V1$=MID$(V1$,2)    PRINT "CHUNK#: ";À≈ŸØ≈”√¡–≈;"^";V1$;À≈ŸØ≈”√¡–≈;"_";    INPUT "", V    SEQØCHUNK(SEQPTR) = V  BEND  IF SSCOL = 1 THEN BEGIN    V = SEQØEXTRA(SEQPTR)    V1$ = STR$(V)    IF LEFT$(V1$,1) = " " THEN V1$=MID$(V1$,2)    PRINT "EXTRA#: ";À≈ŸØ≈”√¡–≈;"^";V1$;À≈ŸØ≈”√¡–≈;"_";    INPUT "", V    SEQØEXTRA(SEQPTR) = V  BEND  RETURN.EDITØCHUNKØCMD'--------------  V = -SEQØCHUNK(SEQPTR)  PRINT À≈ŸØ√Ã“;  FOR ROW = 1 TO √ÕƒØÕ¡ÿ - 1    PRINT ROW;":"; SEQØCMDNAME$(ROW)  NEXT ROW  PRINT  INPUT "CMD: ", V  IF V > 0 THEN SEQØCHUNK(SEQPTR) = -V  RETURN.INSERTØCHUNKØTOØSEQ'-------------------  SEQCNT = SEQCNT + 1  ' MOVE ALL HIGHER CHUNK SEQUENCES UP ONE  K = SEQCNT - 2  DO WHILE K >= SEQPTR    SEQØCHUNK(K+1) = SEQØCHUNK(K)    SEQØEXTRA(K+1) = SEQØEXTRA(K)    K = K - 1  LOOP  SEQØCHUNK(SEQPTR) = 0  SEQØEXTRA(SEQPTR) = 0  RETURN.ADDØCHUNKØTOØSEQ'----------------  SEQPTR = SEQCNT  SEQCNT = SEQCNT + 1  SEQØCHUNK(SEQPTR) = 0  SEQØEXTRA(SEQPTR) = 0  RETURN'----------.STATEØMAIN'----------  HANDLED = 0  IF CH$ = "O" THEN HANDLED = 1 : TRANSPOSEØSTATE = ‘”‘¡‘≈Øœ√‘¡÷≈  IF INSTR("#$", CH$) THEN HANDLED = 1 : GOSUB STATEØSHARPØFLAT  IF INSTR("ABCDEFG", CH$) THEN HANDLED = 1 : GOSUB STATEØNOTE  IF HANDLED = 0 THEN BEGIN    TRANSØV$ = TRANSØV$ + CH$  BEND    IF VERBOSE THEN PRINT "TRANSØV$ = ";TRANSØV$  RETURN'----------------.STATEØSHARPØFLAT'----------------  IF CH$ = "#" THEN CURØFLATØSHARP = Œœ‘≈Ø”»¡“–  IF CH$ = "$" THEN CURØFLATØSHARP = Œœ‘≈Ø∆Ã¡‘  RETURN'----------.STATEØNOTE'----------  IF VERBOSE THEN PRINT "”‘¡‘≈ØŒœ‘≈:"  IF CURØOCTAVE = -1 THEN BEGIN    ERROR$="NO EXPLICIT OCTAVE FOUND BEFORE NOTE"    ERROR=≈““ØÕ…””…Œ«Øœ√‘¡÷≈    RETURN  BEND  CURØNOTE$ = ""  OCTAVEØTWEAKED = 0  IF CURØFLATØSHARP = Œœ‘≈Ø”»¡“– THEN CURØNOTE$ = "#"  IF CURØFLATØSHARP = Œœ‘≈Ø∆Ã¡‘ THEN CURØNOTE$ = "$"  CURØNOTE$ = CURØNOTE$ + CH$  GOSUB GETØCURØNOTEØIDX  IF VERBOSE THEN PRINT "NOTEØIDX=";NOTEØIDX  IF TRANSØDIR = ‘“¡Œ”Ø’– THEN BEGIN    NOTEØIDX = NOTEØIDX + 1    IF NOTEØIDX > 11 THEN BEGIN      OCTAVEØTWEAKED = 1      PREVØOCTAVE = CURØOCTAVE      CURØOCTAVE = CURØOCTAVE + 1      NEWØOCTAVEØFLAG = 1      NOTEØIDX = 0      IF VERBOSE THEN PRINT "PREVØOCT=";PREVØOCTAVE;", CURØOCT=";CURØOCTAVE      IF CURØOCTAVE > 6 THEN BEGIN        ERROR$="OCTAVE OVERFLOW"        ERROR=≈““Øœ√‘¡÷≈Øœ÷≈“∆Ãœ◊        RETURN      BEND    BEND  BEND  IF TRANSØDIR = ‘“¡Œ”Øƒœ◊Œ THEN BEGIN    NOTEØIDX = NOTEØIDX - 1    IF NOTEØIDX < 0 THEN BEGIN      OCTAVEØTWEAKED = 1      PREVØOCTAVE = CURØOCTAVE      CURØOCTAVE = CURØOCTAVE - 1      NEWØOCTAVEØFLAG = 1      NOTEØIDX = 11      IF VERBOSE THEN PRINT "PREVØOCT=";PREVØOCTAVE;", CURØOCT=";CURØOCTAVE      IF CURØOCTAVE < 0 THEN BEGIN        ERROR$="OCTAVE UNDERFLOW"        ERROR=≈““Øœ√‘¡÷≈Ø’Œƒ≈“∆Ãœ◊        RETURN      BEND    BEND  BEND  IF CURØOCTAVE <> PREVØTRANSØOCTAVE OR PREVØOCTAVE = -1 THEN BEGIN    TRANSØV$ = TRANSØV$ + "O" + MID$(STR$(CURØOCTAVE), 2)    PREVØTRANSØOCTAVE = CURØOCTAVE  BEND      IF VERBOSE THEN PRINT "PREVØTRANSØOCTAVE = ";PREVØTRANSØOCTAVE  IF PREVØOCTAVE <> -1 AND OCTAVEØTWEAKED THEN BEGIN    ' REVERT TO PREVIOUS OCTAVE, AS FOLLOWING NOTES MIGHT NOT SUIT TWEAKED OCTAVE    TMP = CURØOCTAVE    CURØOCTAVE = PREVØOCTAVE    PREVØOCTAVE = TMP    IF VERBOSE THEN PRINT "”◊¡–: PREVØOCT=";PREVØOCTAVE;", CURØOCT=";CURØOCTAVE  BEND  NEWØOCTAVEØFLAG = 0  PREVØOCTAVE = CURØOCTAVE  CURØNOTE$ = NOTE$(NOTEØIDX)  TRANSØV$ = TRANSØV$ + CURØNOTE$  CURØFLATØSHARP = Œœ‘≈ØŒœ“Õ¡Ã  RETURN'----------------.GETØCURØNOTEØIDX'----------------  FOR NOTEØIDX = 0 TO 11    IF NOTE$(NOTEØIDX) = CURØNOTE$ THEN RETURN  NEXT NOTEØIDX  NOTEØIDX = -1  ' NOT FOUND  RETURN'------------.STATEØOCTAVE'------------  IF CH$ < "0" OR CH$ > "6" THEN BEGIN    ERROR$="INVALID OCTAVE VALUE"    ERROR=≈““Ø…Œ÷¡Ã…ƒØœ√‘¡÷≈    RETURN  BEND  CURØOCTAVE = VAL(CH$)  NEWØOCTAVEØFLAG = 1  TRANSPOSEØSTATE = ‘”‘¡‘≈ØÕ¡…Œ  RETURN'---------.TRANSPOSE'---------' TESTED IN FILE: "TRANSPOSE.EL"  CURØOCTAVE = -1  PREVØOCTAVE = -1  PREVØTRANSØOCTAVE = -1  TRANSØV$ = ""  TRANSPOSEØSTATE = ‘”‘¡‘≈ØÕ¡…Œ  ERROR = 0  NEWØOCTAVEØFLAG = 0  FOR K = 1 TO LEN(CURØV$)    CH$ = MID$(CURØV$, K, 1)    IF VERBOSE THEN PRINT "TRANSPOSEØSTATE = ";TRANSPOSEØSTATE;    IF VERBOSE THEN PRINT ", CH$=";CH$    ON TRANSPOSEØSTATE GOSUB STATEØMAIN, STATEØOCTAVE    IF ERROR <> 0 THEN K = LEN(CURØV$)  ' BAIL EARLY  NEXT K  RETURN'----------.POLLØDIGIS'----------  ' PARSE AND PLAY THE AUDIO STRING  IF ISØDIGIØPLAYING(DCHAN) THEN BEGIN    IF TI >= TIMEØDURATION(DCHAN) THEN BEGIN      ' PRINT "GOT HERE!"      IF NOT ISØREST(DCHAN) AND SAMPLEØLOOPING(SIDX(DCHAN)) THEN GOSUB ENDØAUDIOØLOOPING      ISØDIGIØPLAYING(DCHAN) = 0      ISØREST(DCHAN) = 0    BEND : ELSE BEGIN      RETURN    BEND  BEND  IF AUDIOIDX(DCHAN) > LEN(V$(6 + DCHAN, CHUNKØIDX)) THEN AUDIOIDX(DCHAN) = -1 : RETURN  IF AUDIOIDX(DCHAN) = -1 THEN RETURN  CH$ = MID$(V$(6 + DCHAN, CHUNKØIDX), AUDIOIDX(DCHAN), 1)  ' PRINT "DCHAN=";DCHAN;" : V$(6 + DCHAN) = ";V$(6 + DCHAN)  'PRINT "AUDIOIDX=";AUDIOIDX(DCHAN);" : CH$=";CH$  IF SEQSTATE(DCHAN) = ”≈—ØÕ¡…Œ THEN BEGIN    IF CH$ = "%" THEN SEQSTATE(DCHAN) = ”≈—Ø”≈Ã≈√‘Ø”¡Õ–Ã≈    IF CH$ = "#" THEN SHARPØFLAG(DCHAN) = 1    IF CH$ = "." THEN DOTTEDØFLAG(DCHAN) = 1    IF CH$ = "-" THEN OCTAVE(DCHAN) = OCTAVE(DCHAN) - 1    IF CH$ = "+" THEN OCTAVE(DCHAN) = OCTAVE(DCHAN) + 1    IF CH$ >= "A" AND CH$ <= "G" THEN BEGIN      IF CH$ >= "C" THEN K = ASC(CH$) - ASC("C")      IF CH$ = "A" THEN K = 5      IF CH$ = "B" THEN K = 6      SRATE = SAMPLEØSRATE(SIDX(DCHAN))      IF SHARPØFLAG(DCHAN) THEN BEGIN        SRATE = SRATE * DTØSEMI ^ (SHARPNOTEMAP(K) + (OCTAVE(DCHAN) - –…‘√»Ø¬≈Œƒ) * 12)      BEND : ELSE BEGIN        SRATE = SRATE * DTØSEMI ^ (NOTEMAP(K) + (OCTAVE(DCHAN) - –…‘√»Ø¬≈Œƒ) * 12)      BEND      SHARPØFLAG(DCHAN) = 0      ISØDIGIØPLAYING(DCHAN) = 1      GOSUB PLAYØWITHØSRATE      IF DOTTEDØFLAG(DCHAN) THEN BEGIN        TIMEØDURATION(DCHAN) = TIMEØDURATION(DCHAN) + DTØDIGI * DURATION(DCHAN) * 1.5      BEND : ELSE BEGIN        TIMEØDURATION(DCHAN) = TIMEØDURATION(DCHAN) + DTØDIGI * DURATION(DCHAN)      BEND      'PRINT "TIMEØDURATION=";TIMEØDURATION(DCHAN)      DOTTEDØFLAG(DCHAN) = 0    BEND    IF CH$ = "S" THEN DURATION(DCHAN) = 1    IF CH$ = "I" THEN DURATION(DCHAN) = 2    IF CH$ = "Q" THEN DURATION(DCHAN) = 4    IF CH$ = "H" THEN DURATION(DCHAN) = 8    IF CH$ = "W" THEN DURATION(DCHAN) = 16    IF CH$ = "R" THEN BEGIN      ISØREST(DCHAN) = 1      IF DOTTEDØFLAG(DCHAN) THEN BEGIN        TIMEØDURATION(DCHAN) = TIMEØDURATION(DCHAN) + DTØDIGI * DURATION(DCHAN) * 1.5      BEND : ELSE BEGIN        TIMEØDURATION(DCHAN) = TIMEØDURATION(DCHAN) + DTØDIGI * DURATION(DCHAN)      BEND      ISØDIGIØPLAYING(DCHAN) = 1      SHARPØFLAG(DCHAN) = 0      DOTTEDØFLAG(DCHAN) = 0    BEND  BEND : GOTO SKIPØSEQ  IF SEQSTATE(DCHAN) = ”≈—Ø”≈Ã≈√‘Ø”¡Õ–Ã≈ THEN BEGIN    SIDX(DCHAN) = VAL(CH$)    ' PRINT "SIDX=";SIDX;"(";CH$;")"    SEQSTATE(DCHAN) = ”≈—ØÕ¡…Œ  BEND.SKIPØSEQ  AUDIOIDX(DCHAN) = AUDIOIDX(DCHAN) + 1  GOTO POLLØDIGIS  ' SEE IF WE'RE IN A POSITION TO PARSE MORE OF THE STRING...  RETURN'--------------.PLAYØWITHØSRATE'--------------  ' PRINT "SAMPLE#";MID$(STR$(SIDX),2);" @ ";HEX$(SRATE)  GOSUB PLAYØVARØSRATE  RETURN'--------------.PLAYØVARØSRATE'--------------  FSTART = SAMPLEØSTART%(SIDX(DCHAN))  FPLAYBACK = SAMPLEØPLAYBACK(SIDX(DCHAN))  FLOOP = SAMPLEØLOOP(SIDX(DCHAN))  FEND = SAMPLEØFINISH(SIDX(DCHAN))  LOOPING = SAMPLEØLOOPING(SIDX(DCHAN))  GOSUB PLAYØAUDIO  RETURN'----------.PLAYØAUDIO'----------  DOFFS = DCHAN * $10  ' SWITCH OFF DIGI CHANNEL 0  POKE $D720 + DOFFS, 0  ' SAMPLE STARTS AT $5.0000  V = FPLAYBACK * 2  POKE $D721 + DOFFS, V AND 255  POKE $D722 + DOFFS, V / 256  POKE $D723 + DOFFS, $05  ' SET PLAYHEAD TO BEGINNING  V = FSTART * 2  POKE $D72A + DOFFS, V AND 255  POKE $D72B + DOFFS, V / 256  POKE $D72C + DOFFS, $05  ' END (LOOP-POINT) OF SAMPLE  IF LOOPING THEN V = FLOOP * 2 : ELSE V = FEND * 2  WPOKE $D727 + DOFFS, V  ' SET DIGI CH0 L/R VOLUMES  POKE $D71C + DCHAN, $AA  POKE $D729 + DOFFS, $AA  ' SAMPLEØRATE = (16000 * 2^24) / (40.5 * 10^6) = 6628 = $19≈4  ' SAMPLE RATE 16K»Z  POKE $D724 + DOFFS, SRATE AND 255  POKE $D725 + DOFFS, (SRATE / 256) AND 255  POKE $D726 + DOFFS, (SRATE / 65536) AND 255  ' PLAY UNSIGNED 16-BIT SOUND WITH LOOPING  K = $80 + $03  IF LOOPING THEN K = K + $40  POKE $D720 + DOFFS, K  RETURN'-----------------.ENDØAUDIOØLOOPING'-----------------  DOFFS = DCHAN * $10  ' END (LOOP-POINT) OF SAMPLE  V = FEND * 2  WPOKE $D727 + DOFFS, V  ' PLAY UNSIGNED 16-BIT SOUND WITHOUT LOOPING  POKE $D720 + DOFFS, $80 + $00 + $03  RETURN